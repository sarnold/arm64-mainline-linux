From 589738178b824e9b235adff1a6ba528207c2d63a Mon Sep 17 00:00:00 2001
From: Johan Hovold <johan+linaro@kernel.org>
Date: Tue, 10 May 2022 17:00:45 +0200
Subject: [PATCH 156/230] hack: efi: disable reset service

The UEFI reset service hangs on reboot and power off on the CRD and
X13s. Disable it so that we fall back to PSCI.

This is needed until the boot firmware provides an RT_PROP table that
describes the supported services. An alternative is to disable all
runtime services by booting with 'efi=noruntime'.

Not-signed-off-by: Johan Hovold <johan+linaro@kernel.org>
---
 drivers/firmware/efi/efi.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/firmware/efi/efi.c b/drivers/firmware/efi/efi.c
index 3bf3c6a3815..2a43b81d000 100644
--- a/drivers/firmware/efi/efi.c
+++ b/drivers/firmware/efi/efi.c
@@ -386,11 +386,20 @@ static struct notifier_block refresh_nv_rng_seed_nb = { .notifier_call = refresh
  */
 static int __init efisubsys_init(void)
 {
+	unsigned int mask;
 	int error;
 
 	if (!efi_enabled(EFI_RUNTIME_SERVICES))
 		efi.runtime_supported_mask = 0;
 
+	/* HACK: disable unsupported reset service */
+	mask = EFI_RT_SUPPORTED_RESET_SYSTEM;
+	if (efi.runtime_supported_mask & mask) {
+		pr_warn(FW_BUG "Runtime services mask contains unsupported services (0x%02x)\n",
+			efi.runtime_supported_mask);
+		efi.runtime_supported_mask &= ~mask;
+	}
+
 	if (!efi_enabled(EFI_BOOT))
 		return 0;
 
-- 
2.39.0

